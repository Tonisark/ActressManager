{% extends 'base.html' %}
{% block content %}
<div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">
  <h2 class="text-3xl font-bold mb-6">Import JSON - Advanced Guide & Preview</h2>
  
  <!-- Upload Form -->
  <form id="jsonForm" method="post" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <div class="mb-6">
      <label for="jsonfile" class="block text-sm font-medium text-gray-700 mb-2">Select JSON File</label>
      <input type="file" id="jsonfile" name="jsonfile" accept=".json" required 
             class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
      <p class="mt-1 text-sm text-gray-500">Supports JSON arrays of objects (e.g., [{"name": "Jane"}, ...]). Auto-detects structure and maps keys to fields.</p>
    </div>
    
    <div class="mb-6">
      <label for="mode" class="block text-sm font-medium text-gray-700 mb-2">Import Mode</label>
      <select id="mode" name="mode" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        <option value="skip">Skip duplicates (fuzzy match >80%)</option>
        <option value="update">Update existing (merge fields on match)</option>
        <option value="overwrite">Overwrite all (dangerous - backs up first)</option>
      </select>
      <p class="mt-1 text-sm text-gray-500">Duplicates detected via name fuzzy matching (e.g., "Abella Reid" vs. "A. Reid").</p>
    </div>
    
    <button type="submit" id="submitBtn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-50" disabled>
      <span id="submitText">Import JSON</span>
      <span id="submitSpinner" class="hidden ml-2">Importing...</span>
    </button>
  </form>

  <!-- Preview Section (Hidden until file selected) -->
  <div id="previewSection" class="mt-8 hidden">
    <h3 class="text-xl font-semibold mb-4">Preview & Auto-Mapping</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Detected Keys & Mappings -->
      <div class="bg-gray-50 p-4 rounded-md">
        <h4 class="font-medium mb-2">Detected Keys (from first object)</h4>
        <ul id="keyList" class="text-sm space-y-1"></ul>
        <div id="mappingSuggestions" class="mt-3">
          <h5 class="font-medium text-sm mb-1">Suggested Auto-Mappings:</h5>
          <ul id="mappingList" class="text-xs text-gray-600 space-y-0.5"></ul>
        </div>
      </div>
      
      <!-- Sample Data Preview -->
      <div class="bg-gray-50 p-4 rounded-md">
        <h4 class="font-medium mb-2">First 5 Objects Preview</h4>
        <div class="overflow-x-auto max-h-64 overflow-y-auto">
          <table id="previewTable" class="min-w-full text-xs border-collapse border border-gray-300">
            <thead class="bg-gray-200 sticky top-0">
              <tr id="tableHeader"></tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
        <p id="objectCount" class="mt-2 text-xs text-gray-500"></p>
      </div>
    </div>
    <div class="mt-4 text-sm text-gray-600">
      <strong>Notes:</strong> Preview shows raw data. Backend will parse ages to integers, dates to ISO, and skip invalid objects. Estimated import: <span id="estimatedObjects"></span> objects.
    </div>
  </div>

  <!-- Comprehensive Guide -->
  <div class="mt-12">
    <h3 class="text-xl font-semibold mb-4">Import Guide</h3>
    
    <!-- Accordion-style sections -->
    <div class="space-y-4">
      <!-- Required Fields -->
      <details class="bg-gray-50 p-4 rounded-md border-l-4 border-indigo-500">
        <summary class="font-medium cursor-pointer">1. Required Fields & Auto-Mapping</summary>
        <div class="mt-3 text-sm text-gray-700">
          <p><strong>Format:</strong> JSON array of objects (e.g., [{"name": "Jane Doe", "age": 28}, ...]).</p>
          <p><strong>Required:</strong> Each object needs a "name" key (case-insensitive synonyms: name, full_name, model_name).</p>
          <p><strong>Auto-Mapped (Optional):</strong> Keys are intelligently mapped to schema fields. Examples:</p>
          <ul class="list-disc list-inside space-y-1 mt-2">
            <li>"aka" / "also_known_as" / "other_names" → aka</li>
            <li>"age" / "years_old" → age (parsed as integer; e.g., 25)</li>
            <li>"dob" / "date_of_birth" / "birthday" → dob (formats: "1986-04-05", "April 5, 1986")</li>
            <li>"height" / "height_inches" → height (e.g., "5'10\"", "170")</li>
            <li>"ethnicity" / "race" / "origin" → ethnicity (matched to dropdowns)</li>
            <li>"tags" / "keywords" / "categories" → tags (array or comma-string → "#tag1, #tag2")</li>
            <li>"folder_name" / "media_folder" → folder_name (auto-generates from name if missing)</li>
            <!-- Mirror backend mappings -->
          </ul>
          <p class="mt-2"><em>Unmapped keys ignored. Download <a href="{{ url_for('export_json') }}" class="text-indigo-600 underline">sample JSON template</a> to start.</em></p>
        </div>
      </details>
      
      <!-- Data Types & Validation -->
      <details class="bg-gray-50 p-4 rounded-md border-l-4 border-green-500">
        <summary class="font-medium cursor-pointer">2. Data Types & Validation</summary>
        <div class="mt-3 text-sm text-gray-700">
          <p>The importer handles flexible JSON structures:</p>
          <ul class="list-disc list-inside space-y-1 mt-2">
            <li><strong>Numbers:</strong> age → int (18-100); weight → text (e.g., "127 lbs")</li>
            <li><strong>Dates:</strong> dob → text (standardized to MM/DD/YYYY)</li>
            <li><strong>Booleans:</strong> has_videos → true/false or 1/0 (defaults false)</li>
            <li><strong>Arrays/Strings:</strong> languages/tags/piercings → comma-separated (e.g., ["English", "Spanish"] → "English, Spanish")</li>
            <li><strong>Selects:</strong> ethnicity/status → matched to options; unknowns → "Other"</li>
          </ul>
          <p><strong>Errors:</strong> Invalid objects (e.g., no name, age <18) skipped with summary. Encoding: UTF-8; large files (>10MB) chunked.</p>
        </div>
      </details>
      
      <!-- Common Issues -->
      <details class="bg-gray-50 p-4 rounded-md border-l-4 border-yellow-500">
        <summary class="font-medium cursor-pointer">3. Common Issues & Troubleshooting</summary>
        <div class="mt-3 text-sm text-gray-700">
          <ul class="list-disc list-inside space-y-1">
            <li><strong>Format Errors:</strong> Not an array? Or non-objects? Preview flags structure issues.</li>
            <li><strong>Missing Keys:</strong> Objects without "name" skipped; preview shows sample.</li>
            <li><strong>Duplicates:</strong> Fuzzy matching warns; "Update" mode merges on name similarity.</li>
            <li><strong>Nested Data:</strong> Only top-level keys mapped; flatten before import.</li>
            <li><strong>File Size:</strong> Max 50MB; split large arrays.</li>
          </ul>
          <p><em>Post-import: Check <a href="{{ url_for('index') }}" class="text-indigo-600 underline">Dashboard</a>. Errors? View logs.</em></p>
        </div>
      </details>
      
      <!-- Sample JSON -->
      <details class="bg-gray-50 p-4 rounded-md border-l-4 border-blue-500">
        <summary class="font-medium cursor-pointer">4. Sample JSON</summary>
        <div class="mt-3">
          <p class="text-sm text-gray-700 mb-2">Copy-paste this into a .json file:</p>
          <pre class="bg-gray-100 p-3 rounded text-xs overflow-x-auto font-mono" style="white-space: pre-wrap;">[
  {
    "name": "Jane Doe",
    "aka": "J. Doe",
    "age": 28,
    "dob": "January 15, 1997",
    "ethnicity": "Caucasian",
    "height": "5'6\"",
    "description": "Award-winning actress specializing in drama.",
    "tags": ["#drama", "#indie"]
  },
  {
    "name": "John Smith",
    "age": 32,
    "dob": "05/20/1993",
    "ethnicity": "Asian",
    "height": "175 cm",
    "description": "Versatile performer with 10+ years experience.",
    "tags": ["#action", "#comedy"]
  }
]</pre>
          <p class="mt-1 text-xs text-gray-500">This matches your schema. Import to test.</p>
        </div>
      </details>
    </div>
  </div>
</div>

<script>
  // Client-side JSON Preview
  document.getElementById('jsonfile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(ev) {
      try {
        const data = JSON.parse(ev.target.result);
        if (!Array.isArray(data)) {
          alert('Invalid JSON: Must be an array of objects.');
          return;
        }
        if (data.length === 0) {
          alert('Empty array: No data to import.');
          return;
        }
        
        // Show preview
        document.getElementById('previewSection').classList.remove('hidden');
        populatePreview(data);
        document.getElementById('submitBtn').disabled = false;
      } catch (err) {
        alert('Invalid JSON: ' + err.message);
      }
    };
    reader.readAsText(file, 'UTF-8');
  });

  // Populate Preview
  function populatePreview(data) {
    const sampleObj = data[0] || {};
    const keys = Object.keys(sampleObj);
    const samples = data.slice(0, 5);
    
    // Keys List
    const keyList = document.getElementById('keyList');
    keyList.innerHTML = keys.map(k => `<li class="flex justify-between"><span>${k}</span><span class="text-indigo-600">${getMapping(k)}</span></li>`).join('');
    
    // Mappings
    const mappings = getAllMappings(keys);
    const mappingList = document.getElementById('mappingList');
    mappingList.innerHTML = Object.entries(mappings).map(([from, to]) => `<li><strong>${from}</strong> → ${to}</li>`).join('');
    
    // Table (limit columns to first 8 for readability)
    const displayKeys = keys.slice(0, 8);
    const tableHeader = document.getElementById('tableHeader');
    tableHeader.innerHTML = displayKeys.map(k => `<th class="border px-2 py-1">${k}</th>`).join('') + '<th class="border px-2 py-1">...</th>';
    
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = samples.map(obj => {
      const cells = displayKeys.map(k => `<td class="border px-2 py-1">${JSON.stringify(obj[k] || '').replace(/"/g, '&quot;')}</td>`).join('') + '<td class="border px-2 py-1 text-gray-500">...</td>';
      return `<tr>${cells}</tr>`;
    }).join('');
    
    // Counts
    document.getElementById('objectCount').textContent = `Preview: ${samples.length} objects (total: ${data.length})`;
    document.getElementById('estimatedObjects').textContent = data.length;
  }

  // Mapping Logic (mirrors backend)
  const SYNONYMS = {
    name: ['name', 'full_name', 'model_name', 'actor', 'actress'],
    aka: ['aka', 'also_known_as', 'other_names'],
    age: ['age', 'years_old'],
    dob: ['dob', 'date_of_birth', 'birthday'],
    ethnicity: ['ethnicity', 'race', 'origin'],
    height: ['height', 'height_inches'],
    tags: ['tags', 'keywords', 'categories'],
    description: ['description', 'bio'],
    // Add more
  };

  function getMapping(key) {
    const lower = key.toLowerCase();
    for (const [field, syns] of Object.entries(SYNONYMS)) {
      if (syns.some(s => lower.includes(s))) return field;
    }
    return 'Unmapped';
  }

  function getAllMappings(keys) {
    const map = {};
    keys.forEach(k => {
      const m = getMapping(k);
      if (m !== 'Unmapped') map[k] = m;
    });
    return map;
  }

  // Submit with Spinner
  document.getElementById('jsonForm').addEventListener('submit', function() {
    const btn = document.getElementById('submitBtn');
    const text = document.getElementById('submitText');
    const spinner = document.getElementById('submitSpinner');
    btn.disabled = true;
    text.classList.add('hidden');
    spinner.classList.remove('hidden');
  });
</script>
{% endblock %}